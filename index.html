<html>
    <head>
        <meta charset="utf-8" />
        <title>Meu Primeiro Jogo Multiplayer</title>

        <style>
            #screen {
                border: 10px solid #ccc;
                background-color: black;
                image-rendering: pixelated;
                image-rendering: crisp-edges;
                image-rendering: -moz-crisp-edges;
                width: 630;
                height: 630;
                position: absolute;
                left: 25%;
                display: block;
            }

            #scoreboard {
                width: 100px;
                height: 50px;
            }

            #demo {
                border: 1px solid black;
                border-radius:10px;
                text-align: center;
                font-size: 50px;
                font-weight: bold;
            }

        </style>
    </head>
    <body>
        <canvas id="screen" width="500" height="500"></canvas>

        <div id="scoreboard">
            <p id="demo">0:0</p>
        </div>

        <script type="module">
            import createKeyboardListener from './keyboardListener.js'

            const screen = document.getElementById("screen")
            const context = screen.getContext("2d")
            
            const widthPlayer = 2
            const heightPlayer = 50

            const widthBall = 5
            const heightBall = 5

            const state = {
                players:{
                    'player1': {x:30, y:225, width:widthPlayer, height:heightPlayer, score: 0},
                    'player2': {x:470, y:225, width:widthPlayer, height:heightPlayer, score: 0}
                },
                balls:{
                    'ball1': {x:248, y:248, width:widthBall, height:heightBall, horizontal:-1, vertical:-1}
                }
            }

            function createGame() {
                function movePlayer(command) {
                    console.log(command)
                    console.log(`game.movePlayer() -> Moving ${command.playerId} with ${command.keyPressed}`)

                    const acceptedMoves = {
                        w(player) {
                            const move = 10
                            console.log('game.movePlayer().ArrowUp() ->Moving PLayer Up')
                            if (player.y - move >= 0) {
                                player.y -= move
                                return
                            } else if (player.y > 0) {
                                player.y = 0
                                return
                            }
                        },
                        s(player) {
                            const move = 10
                            console.log('game.movePlayer().ArrowDown() ->Moving PLayer Down')
                            if (player.y + move <= 500-player.height) {
                                player.y += move
                                return
                            } else if (player.y < 500-player.height) {
                                player.y = 500-player.height
                                return
                            }
                        }
                    }
                
                    const keyPressed = command.keyPressed
                    const player = state.players[command.playerId]
                    const moveFunction = acceptedMoves[keyPressed]
                    
                    if (moveFunction){
                        moveFunction(player)
                    } 
                }
                
                function moveBall() {
                    state.balls["ball1"].x += 10*state.balls["ball1"].horizontal / 3
                    state.balls["ball1"].y += 5*state.balls["ball1"].vertical / 3
                    checkBallCollision()
                }
                
                function checkBallCollision() {
                    const ball = state.balls["ball1"]
                    if (ball.x >= 490) {
                        victory(state.players['player1'])
                    }

                    if (ball.x <= 5) {
                        victory(state.players['player2'])
                    }

                    if (ball.y >= 490 || ball.y <= 0) {
                        ball.vertical = ball.vertical * (-1)
                    }

                    var player = state.players["player1"]

                    if ((player.x <= ball.x && ball.x <= player.x + 2) && (player.y <= ball.y && ball.y <= player.y + 50)) {
                        console.log(`Collision detected with ${player}`)
                        ball.horizontal = 1
                    }

                    var player = state.players["player2"]

                    if ((player.x - 5 <= ball.x && ball.x <= player.x + 2) && (player.y <= ball.y && ball.y <= player.y + 50)) {
                        console.log(`Collision detected with ${player}`)
                        ball.horizontal = -1
                    }

                    function victory(player) {
                        player.score += 1

                        document.getElementById("demo").innerHTML = `${state.players["player1"].score}:${state.players["player2"].score}`;

                        console.log(`Placar: ${state.players["player1"].score}:${state.players["player2"].score}`)

                        var num = -1
                        if (player.x < 248){
                            num = 1
                        }
                        
                        ball.horizontal = num
                        ball.vertical = -1
                        ball.x = 248
                        ball.y = 248

                        state.players["player1"].x = 30
                        state.players["player1"].y = 225

                        state.players["player2"].x = 470
                        state.players["player2"].y = 225
                    }
                }

                return {
                    movePlayer,
                    checkBallCollision,
                    moveBall,
                    state
                }
            }       

            const game = createGame()
            const keyboardListener = createKeyboardListener()
            keyboardListener.subscribe(game.movePlayer)
            setInterval( game.moveBall, 1000 / 30 )
            



            renderScreen()
            
            function renderScreen() {
                context.fillStyle = 'black'
                context.fillRect(0, 0, 500, 500)


                for (const playerId in state.players) {
                    const player = state.players[playerId]
                    context.fillStyle = 'white'
                    context.fillRect(player.x, player.y, player.width, player.height)
                }


                for (const ballId in state.balls) {
                    const ball = state.balls[ballId]
                    context.fillStyle = 'white'
                    context.fillRect(ball.x, ball.y, ball.width, ball.height)
                }
                
                requestAnimationFrame(renderScreen)
            }


        </script>
    </body>
</html>