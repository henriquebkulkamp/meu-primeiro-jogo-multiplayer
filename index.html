<html>
    <head>
        <meta charset="utf-8" />
        <title>Meu Primeiro Jogo Multiplayer</title>

        <style>
            #screen {
                border: 10px solid #ccc;
                background-color: black;
                image-rendering: pixelated;
                image-rendering: crisp-edges;
                image-rendering: -moz-crisp-edges;
                width: 630;
                height: 630;
                position: absolute;
                left: 25%;
                display: block;
            }
        </style>
    </head>
    <body>
        <canvas id="screen" width="500" height="500"></canvas>

        <script>
            const screen = document.getElementById("screen")
            const context = screen.getContext("2d")

            const state = {
                players:{
                    'player1': {x:30, y:225},
                    'player2': {x:470, y:225}
                },
                balls:{
                    'ball1': {x:248, y:248}
                }
            }

            function createGame() {
                function movePlayer(command) {
                    console.log(`Moving ${command.playerId} with ${command.keyPressed}`)
                
                    const keyPressed = command.keyPressed
                    const player = state.players[command.playerId]

                    if (keyPressed === 'ArrowUp' && player.y - 1 >= 0) {
                        player.y -= 5
                        return
                    }

                    if (keyPressed === 'ArrowDown' && player.y + 1 <= 450) {
                        player.y += 5
                        return
                    } 
                }

                return {
                    movePlayer,
                    state
                }

            }

            const game = createGame()
            const keyboardListener = createKeyboardListener()
            keyboardListener.subscribe(game.movePlayer)
            


            function createKeyboardListener() {
                const state = {
                    observers: []
                }

                function subscribe(observerFunction) {
                    state.observers.push(observerFunction)
                }

                function notifyAll(command) {
                    console.log(`Notifying ${state.observers.length} observers`)

                    for (const observerFunction of state.observers) {
                        observerFunction(command)
                    }
                }

                document.addEventListener('keydown', handleKeyDown)

                function handleKeyDown(event) {
                    const keyPressed = event.key

                    const command = {
                        playerId : 'player1', 
                        keyPressed
                    }

                    notifyAll(command)
                }

                return {
                    subscribe
                }
            }

            renderScreen()
            
            function renderScreen() {
                context.fillStyle = 'black'
                context.fillRect(0, 0, 500, 500)


                for (const playerId in state.players) {
                    const player = state.players[playerId]
                    context.fillStyle = 'white'
                    context.fillRect(player.x, player.y, 2, 50)
                }


                for (const ballId in state.balls) {
                    const ball = state.balls[ballId]
                    context.fillStyle = 'white'
                    context.fillRect(ball.x, ball.y, 5, 5)
                }
                
                requestAnimationFrame(renderScreen)
            }


        </script>
    </body>
</html>